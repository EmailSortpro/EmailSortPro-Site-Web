// PageManager.js - Version 15.0 - Gestionnaire de pages optimis√© avec persistance

class PageManager {
    constructor() {
        // √âtat principal
        this.currentPage = null;
        this.selectedEmails = new Set();
        this.aiAnalysisResults = new Map();
        this.createdTasks = new Map();
        this.autoAnalyzeEnabled = true;
        this.searchTerm = '';
        this.lastScanData = null;
        this.hideExplanation = localStorage.getItem('hideEmailExplanation') === 'true';
        
        // SYST√àME EMAIL OPTIMIS√â avec persistance
        this.emailsCache = {
            rawEmails: [],
            processedEmails: [],
            lastUpdate: null,
            scanInProgress: false,
            errors: [],
            source: null
        };
        
        // Vue modes
        this.currentViewMode = 'grouped-domain';
        this.currentCategory = null;
        
        // √âtat provider avec cache
        this.currentProvider = null;
        this.connectionStatus = {
            gmail: false,
            outlook: false,
            lastCheck: null,
            authenticated: false
        };
        this._providerCache = null;
        this._providerCacheTime = 0;
        this.PROVIDER_CACHE_DURATION = 30000; // 30 secondes
        
        // Check provider toutes les 60 secondes au lieu de 30
        this.providerCheckInterval = null;
        this.PROVIDER_CHECK_INTERVAL = 60000;
        
        // Priorit√©s cat√©gories
        this.categoryPriority = {
            'marketing_news': 1000,
            'spam': 950,
            'security': 900,
            'finance': 850,
            'tasks': 800,
            'meetings': 750,
            'commercial': 700,
            'support': 650,
            'hr': 600,
            'notifications': 100,
            'reminders': 500,
            'project': 450,
            'internal': 400,
            'cc': 350,
            'other': 0
        };
        
        // Renderers de pages
        this.pages = {
            scanner: (container) => this.renderScanner(container),
            emails: (container) => this.renderEmails(container),
            tasks: (container) => this.renderTasks(container),
            categories: (container) => this.renderCategories(container),
            settings: (container) => this.renderSettings(container),
            ranger: (container) => this.renderRanger(container)
        };
        
        // Initialisation diff√©r√©e
        this.initialized = false;
        this.initializeAsync();
    }

    async initializeAsync() {
        console.log('[PageManager] ‚úÖ Version 15.0 - Optimis√© avec persistance');
        
        // Charger le cache depuis localStorage
        this.loadEmailsFromPersistentCache();
        
        // D√©tecter provider initial
        this.detectProviders();
        
        // Setup √©v√©nements
        this.setupEventListeners();
        
        // D√©marrer monitoring provider
        this.startProviderMonitoring();
        
        this.initialized = true;
    }

    // ================================================
    // GESTION PERSISTANCE OPTIMIS√âE
    // ================================================
    
    loadEmailsFromPersistentCache() {
        try {
            // 1. V√©rifier localStorage avec expiration
            const stored = localStorage.getItem('emailsCachePersistent');
            if (stored) {
                const data = JSON.parse(stored);
                
                // V√©rifier expiration (24h)
                if (data.expiry && data.expiry > Date.now()) {
                    console.log(`[PageManager] üì¶ ${data.emails.length} emails charg√©s depuis cache persistant`);
                    this.emailsCache.processedEmails = data.emails;
                    this.emailsCache.lastUpdate = data.timestamp;
                    this.emailsCache.source = 'persistent_cache';
                    return true;
                } else {
                    // Cache expir√©, le supprimer
                    localStorage.removeItem('emailsCachePersistent');
                }
            }
            
            // 2. Fallback sur sessionStorage
            const sessionData = sessionStorage.getItem('lastScanResults');
            if (sessionData) {
                const data = JSON.parse(sessionData);
                if (data.emails && Array.isArray(data.emails)) {
                    console.log(`[PageManager] üì• ${data.emails.length} emails charg√©s depuis session`);
                    this.emailsCache.processedEmails = data.emails;
                    this.emailsCache.lastUpdate = data.timestamp;
                    this.emailsCache.source = 'session_cache';
                    return true;
                }
            }
        } catch (error) {
            console.warn('[PageManager] ‚ö†Ô∏è Erreur chargement cache:', error);
        }
        
        return false;
    }

    saveEmailsToPersistentCache(emails) {
        try {
            // Limiter √† 200 emails pour √©viter quota localStorage
            const limitedEmails = emails.slice(0, 200);
            
            const data = {
                emails: limitedEmails,
                timestamp: Date.now(),
                provider: this.currentProvider,
                total: emails.length,
                expiry: Date.now() + (24 * 60 * 60 * 1000) // 24 heures
            };
            
            localStorage.setItem('emailsCachePersistent', JSON.stringify(data));
            
            // Aussi sauvegarder en session pour compatibilit√©
            sessionStorage.setItem('lastScanResults', JSON.stringify(data));
            
            console.log(`[PageManager] üíæ ${limitedEmails.length} emails sauvegard√©s (sur ${emails.length} total)`);
            
        } catch (error) {
            console.warn('[PageManager] ‚ö†Ô∏è Erreur sauvegarde cache:', error);
            
            // Si quota d√©pass√©, essayer avec moins d'emails
            if (error.name === 'QuotaExceededError') {
                try {
                    const minimalEmails = emails.slice(0, 50);
                    const minimalData = {
                        emails: minimalEmails,
                        timestamp: Date.now(),
                        provider: this.currentProvider,
                        total: emails.length,
                        expiry: Date.now() + (24 * 60 * 60 * 1000)
                    };
                    localStorage.setItem('emailsCachePersistent', JSON.stringify(minimalData));
                    console.log(`[PageManager] üíæ Sauvegarde minimale: ${minimalEmails.length} emails`);
                } catch (e) {
                    console.error('[PageManager] ‚ùå Impossible de sauvegarder le cache');
                }
            }
        }
    }

    // ================================================
    // D√âTECTION PROVIDER AVEC CACHE
    // ================================================
    
    detectProviders() {
        // Utiliser le cache si valide
        const now = Date.now();
        if (this._providerCache && (now - this._providerCacheTime) < this.PROVIDER_CACHE_DURATION) {
            return this._providerCache;
        }
        
        // Reset status
        this.connectionStatus = {
            gmail: false,
            outlook: false,
            lastCheck: now,
            authenticated: false
        };
        
        let provider = null;
        
        // PRIORIT√â 1: Gmail
        if (window.googleAuthService?.isAuthenticated?.()) {
            this.connectionStatus.gmail = true;
            this.connectionStatus.authenticated = true;
            provider = 'gmail';
        } 
        // PRIORIT√â 2: Outlook
        else if (window.authService?.isAuthenticated?.()) {
            this.connectionStatus.outlook = true;
            this.connectionStatus.authenticated = true;
            provider = 'outlook';
        }
        
        // Mettre en cache
        this._providerCache = provider;
        this._providerCacheTime = now;
        this.currentProvider = provider;
        
        // Log seulement si changement
        if (provider !== this.currentProvider) {
            console.log(`[PageManager] üîå Provider: ${this.currentProvider} ‚Üí ${provider}`);
        }
        
        return provider;
    }

    clearProviderCache() {
        this._providerCache = null;
        this._providerCacheTime = 0;
    }

    getProviderInfo() {
        const provider = this.detectProviders();
        
        const providers = {
            gmail: {
                name: 'Gmail',
                icon: 'fab fa-google',
                color: '#ea4335',
                status: 'connected',
                priority: 'high',
                optimized: true,
                canScan: true
            },
            outlook: {
                name: 'Outlook',
                icon: 'fab fa-microsoft',
                color: '#0078d4',
                status: 'connected',
                priority: 'normal',
                optimized: true,
                canScan: true
            }
        };
        
        return providers[provider] || {
            name: 'Non connect√©',
            icon: 'fas fa-unlink',
            color: '#6b7280',
            status: 'disconnected',
            priority: 'none',
            optimized: false,
            canScan: false
        };
    }

    // ================================================
    // MONITORING PROVIDER OPTIMIS√â
    // ================================================
    
    startProviderMonitoring() {
        if (this.providerCheckInterval) return;
        
        // Check toutes les 60 secondes
        this.providerCheckInterval = setInterval(() => {
            const oldProvider = this.currentProvider;
            const newProvider = this.detectProviders();
            
            if (oldProvider !== newProvider) {
                console.log(`[PageManager] üîÑ Provider chang√©: ${oldProvider} ‚Üí ${newProvider}`);
                this.handleProviderChange(oldProvider, newProvider);
            }
        }, this.PROVIDER_CHECK_INTERVAL);
    }

    stopProviderMonitoring() {
        if (this.providerCheckInterval) {
            clearInterval(this.providerCheckInterval);
            this.providerCheckInterval = null;
        }
    }

    handleProviderChange(oldProvider, newProvider) {
        // Effacer le cache si d√©connexion
        if (!newProvider && oldProvider) {
            console.log('[PageManager] üîå D√©connexion d√©tect√©e, cache conserv√©');
        }
        
        // Mettre √† jour l'affichage si n√©cessaire
        if (this.currentPage === 'emails') {
            this.updateProviderInfoDisplay();
        }
        
        // Dispatcher √©v√©nement
        this.dispatchEvent('providerChanged', {
            oldProvider,
            newProvider,
            connectionStatus: this.connectionStatus
        });
    }

    // ================================================
    // R√âCUP√âRATION EMAILS OPTIMIS√âE
    // ================================================
    
    async getAllEmailsRobust() {
        console.log('[PageManager] üìß R√©cup√©ration emails robuste...');
        
        // 1. Cache en m√©moire
        if (this.emailsCache.processedEmails.length > 0) {
            console.log(`[PageManager] ‚úÖ ${this.emailsCache.processedEmails.length} emails depuis cache m√©moire`);
            return this.emailsCache.processedEmails;
        }
        
        // 2. EmailScanner si disponible
        if (window.emailScanner?.getAllEmails) {
            try {
                const scannerEmails = window.emailScanner.getAllEmails();
                if (scannerEmails && scannerEmails.length > 0) {
                    console.log(`[PageManager] ‚úÖ ${scannerEmails.length} emails depuis EmailScanner`);
                    this.updateEmailsCache(scannerEmails, 'emailScanner');
                    return this.emailsCache.processedEmails;
                }
            } catch (error) {
                console.warn('[PageManager] ‚ö†Ô∏è Erreur EmailScanner:', error);
            }
        }
        
        // 3. Si provider connect√© et pas de scan en cours
        const provider = this.detectProviders();
        if (provider && !this.emailsCache.scanInProgress) {
            // Proposer scan automatique seulement si premi√®re visite
            const hasPromptedAutoScan = sessionStorage.getItem('autoScanPrompted');
            
            if (!hasPromptedAutoScan && this.shouldPromptAutoScan()) {
                sessionStorage.setItem('autoScanPrompted', 'true');
                const shouldScan = await this.promptForAutoScan();
                
                if (shouldScan) {
                    try {
                        const emails = await this.performQuickScan();
                        if (emails && emails.length > 0) {
                            return emails;
                        }
                    } catch (error) {
                        console.error('[PageManager] Erreur scan rapide:', error);
                    }
                }
            }
        }
        
        console.log('[PageManager] üì≠ Aucun email disponible');
        return [];
    }

    shouldPromptAutoScan() {
        // Proposer auto-scan seulement si:
        // - Premi√®re visite de la session
        // - Provider connect√©
        // - Pas de cache valide
        return !this.emailsCache.lastUpdate && this.currentProvider;
    }

    async promptForAutoScan() {
        return new Promise((resolve) => {
            if (window.uiManager?.showConfirmDialog) {
                window.uiManager.showConfirmDialog({
                    title: 'Scanner vos emails ?',
                    message: `Aucun email trouv√©. Voulez-vous lancer un scan rapide de vos emails ${this.currentProvider === 'gmail' ? 'Gmail' : 'Outlook'} ?`,
                    confirmText: 'Scanner',
                    cancelText: 'Plus tard',
                    onConfirm: () => resolve(true),
                    onCancel: () => resolve(false)
                });
            } else {
                // Fallback simple
                resolve(confirm('Aucun email trouv√©. Voulez-vous lancer un scan rapide ?'));
            }
        });
    }

    async performQuickScan() {
        console.log('[PageManager] üöÄ Scan rapide d√©marr√©...');
        
        if (!window.emailScanner?.scan) {
            throw new Error('EmailScanner non disponible');
        }
        
        window.uiManager?.showLoading('Scan rapide en cours...');
        
        try {
            const scanOptions = {
                days: 7, // Scan rapide sur 7 jours
                maxEmails: 100, // Limiter pour la rapidit√©
                autoAnalyze: false, // Pas d'IA pour aller plus vite
                autoCategrize: true,
                onProgress: (progress) => {
                    if (window.uiManager?.updateLoadingMessage) {
                        window.uiManager.updateLoadingMessage(progress.message || 'Scan en cours...');
                    }
                }
            };
            
            const results = await window.emailScanner.scan(scanOptions);
            
            if (results && results.emails) {
                this.updateEmailsCache(results.emails, 'quickScan');
                window.uiManager?.hideLoading();
                window.uiManager?.showToast(`‚úÖ ${results.emails.length} emails trouv√©s`, 'success');
                return results.emails;
            }
            
        } catch (error) {
            window.uiManager?.hideLoading();
            throw error;
        }
        
        return [];
    }

    updateEmailsCache(emails, source) {
        console.log(`[PageManager] üì¶ Mise √† jour cache depuis ${source}: ${emails.length} emails`);
        
        this.emailsCache.processedEmails = [...emails];
        this.emailsCache.lastUpdate = Date.now();
        this.emailsCache.source = source;
        
        // Sauvegarder dans le cache persistant
        this.saveEmailsToPersistentCache(emails);
        
        // Dispatcher √©v√©nement
        this.dispatchEvent('emailsCacheUpdated', {
            count: emails.length,
            source: source,
            timestamp: Date.now()
        });
    }

    // ================================================
    // RECHERCHE EMAIL OPTIMIS√âE
    // ================================================
    
    getEmailById(emailId) {
        if (!emailId) return null;
        
        // 1. Cache m√©moire (plus rapide)
        let email = this.emailsCache.processedEmails.find(e => e.id === emailId);
        if (email) return email;
        
        // 2. EmailScanner
        if (window.emailScanner) {
            // M√©thode directe si disponible
            if (typeof window.emailScanner.getEmailById === 'function') {
                email = window.emailScanner.getEmailById(emailId);
                if (email) return email;
            }
            
            // Sinon chercher dans getAllEmails
            if (typeof window.emailScanner.getAllEmails === 'function') {
                const allEmails = window.emailScanner.getAllEmails();
                email = allEmails.find(e => e.id === emailId);
                if (email) return email;
            }
        }
        
        console.warn(`[PageManager] Email non trouv√©: ${emailId}`);
        return null;
    }

    // ================================================
    // ACTUALISATION EMAILS
    // ================================================
    
    async refreshEmails() {
        const provider = this.detectProviders();
        if (!provider) {
            window.uiManager?.showToast('Aucun service email connect√©', 'warning');
            return;
        }
        
        window.uiManager?.showLoading('Actualisation des emails...');
        
        try {
            // Effacer le cache
            this.emailsCache = {
                rawEmails: [],
                processedEmails: [],
                lastUpdate: null,
                scanInProgress: false,
                errors: [],
                source: null
            };
            
            // Effacer aussi le cache persistant
            localStorage.removeItem('emailsCachePersistent');
            sessionStorage.removeItem('lastScanResults');
            
            // Lancer un scan complet
            if (window.emailScanner?.scan) {
                const results = await window.emailScanner.scan({
                    days: 7,
                    autoAnalyze: true,
                    autoCategrize: true,
                    onProgress: (progress) => {
                        if (window.uiManager?.updateLoadingMessage) {
                            window.uiManager.updateLoadingMessage(progress.message);
                        }
                    }
                });
                
                if (results && results.emails) {
                    this.updateEmailsCache(results.emails, 'refresh');
                }
            }
            
            // Recharger la page emails
            if (this.currentPage === 'emails') {
                await this.loadPage('emails');
            }
            
            window.uiManager?.showToast(`Emails actualis√©s (${provider})`, 'success');
            
        } catch (error) {
            console.error('[PageManager] Erreur actualisation:', error);
            window.uiManager?.showToast(`Erreur: ${error.message}`, 'error');
        } finally {
            window.uiManager?.hideLoading();
        }
    }

    // ================================================
    // RENDU PAGE EMAILS OPTIMIS√â
    // ================================================
    
    async renderEmails(container) {
        console.log('[PageManager] üìß Rendu page emails...');
        
        const emails = await this.getAllEmailsRobust();
        const categories = window.categoryManager?.getCategories() || {};
        const providerInfo = this.getProviderInfo();
        
        console.log(`[PageManager] üìß ${emails.length} emails √† afficher (${this.currentProvider || 'non connect√©'})`);
        
        if (emails.length === 0) {
            container.innerHTML = this.renderEmptyEmailsState();
            return;
        }

        // Assurer la d√©tection Newsletter/Spam
        this.ensureNewsletterSpamPriority(emails);

        const categoryCounts = this.calculateCategoryCounts(emails);
        const totalEmails = emails.length;
        const selectedCount = this.selectedEmails.size;
        
        // Statistiques
        const stats = {
            newsletter: emails.filter(e => e.category === 'marketing_news').length,
            spam: emails.filter(e => e.category === 'spam').length,
            preselected: emails.filter(e => e.isPreselectedForTasks).length
        };
        
        container.innerHTML = `
            <div class="tasks-page-modern">
                <!-- Statut cache et provider -->
                ${this.renderCacheStatus(providerInfo)}
                
                <!-- Texte explicatif -->
                ${this.renderExplanationText(providerInfo, stats)}

                <!-- Contr√¥les -->
                ${this.renderControlsBar(selectedCount, providerInfo)}

                <!-- Container fixe (clone) -->
                <div class="sticky-controls-container">
                    <!-- Contenu clon√© dynamiquement -->
                </div>

                <!-- Contenu emails -->
                <div class="tasks-container-harmonized">
                    ${this.renderEmailsList()}
                </div>
            </div>
        `;

        this.addEmailStyles();
        this.setupEmailsEventListeners();
        this.setupStickyControls();
        
        // Auto-analyze si activ√© (limit√©)
        if (this.autoAnalyzeEnabled && emails.length > 0) {
            this.scheduleAutoAnalysis(emails);
        }
    }

    renderCacheStatus(providerInfo) {
        const cacheAge = this.emailsCache.lastUpdate ? 
            Math.round((Date.now() - this.emailsCache.lastUpdate) / 1000 / 60) : 0;
        
        return `
            <div class="cache-status-info">
                <div class="cache-indicators">
                    <div class="cache-indicator ${this.emailsCache.processedEmails.length > 0 ? 'active' : ''}">
                        <i class="fas fa-database"></i>
                        <span>Cache: ${this.emailsCache.processedEmails.length} emails</span>
                        ${cacheAge > 0 ? `<span class="cache-age">(${cacheAge}min)</span>` : ''}
                    </div>
                    <div class="provider-indicator ${providerInfo.status === 'connected' ? 'connected' : 'disconnected'}">
                        <i class="${providerInfo.icon}"></i>
                        <span>${providerInfo.name}</span>
                        ${providerInfo.optimized ? '<span class="opt-badge">‚ú®</span>' : ''}
                    </div>
                    <div class="scan-indicator ${this.emailsCache.scanInProgress ? 'scanning' : ''}">
                        <i class="fas fa-sync-alt ${this.emailsCache.scanInProgress ? 'fa-spin' : ''}"></i>
                        <span>${this.emailsCache.scanInProgress ? 'Scan...' : 'Pr√™t'}</span>
                    </div>
                    ${this.emailsCache.source ? `
                        <div class="source-indicator">
                            <i class="fas fa-info-circle"></i>
                            <span>Source: ${this.emailsCache.source}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    renderExplanationText(providerInfo, stats) {
        if (this.hideExplanation) return '';
        
        return `
            <div class="explanation-text-harmonized ${providerInfo.status === 'connected' ? 'provider-connected' : 'provider-disconnected'}">
                <div class="explanation-content">
                    <div class="explanation-main">
                        <i class="fas fa-info-circle"></i>
                        <span>
                            Cliquez sur vos emails pour les s√©lectionner, puis utilisez les boutons d'action. 
                            <strong>D√©tection Newsletter/Spam active.</strong>
                        </span>
                    </div>
                    <div class="explanation-stats">
                        ${stats.newsletter > 0 ? `<span class="stat-item newsletter">üì∞ ${stats.newsletter} newsletters</span>` : ''}
                        ${stats.spam > 0 ? `<span class="stat-item spam">üö´ ${stats.spam} spam</span>` : ''}
                        ${stats.preselected > 0 ? `<span class="stat-item preselected">‚≠ê ${stats.preselected} pr√©-s√©lectionn√©s</span>` : ''}
                        <span class="stat-item provider" style="color: ${providerInfo.color};">
                            <i class="${providerInfo.icon}"></i> ${providerInfo.name}
                        </span>
                    </div>
                </div>
                <button class="explanation-close-btn" onclick="window.pageManager.hideExplanationMessage()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }

    renderControlsBar(selectedCount, providerInfo) {
        const visibleEmails = this.getVisibleEmails();
        const allSelected = visibleEmails.length > 0 && 
                           visibleEmails.every(email => this.selectedEmails.has(email.id));
        
        return `
            <div class="controls-and-filters-container">
                <div class="controls-bar-single-line">
                    <!-- Actions de scan -->
                    <div class="scan-controls">
                        <button class="btn-action btn-scan" onclick="window.pageManager.refreshEmails()" 
                                ${this.emailsCache.scanInProgress ? 'disabled' : ''}>
                            <i class="fas fa-sync-alt ${this.emailsCache.scanInProgress ? 'fa-spin' : ''}"></i>
                            <span class="btn-text">Actualiser</span>
                        </button>
                        
                        ${providerInfo.canScan ? `
                            <button class="btn-action btn-scanner" onclick="window.pageManager.loadPage('scanner')">
                                <i class="fas fa-search"></i>
                                <span class="btn-text">Scanner</span>
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Recherche -->
                    <div class="search-section">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                   class="search-input" 
                                   id="emailSearchInput"
                                   placeholder="Rechercher..." 
                                   value="${this.searchTerm}">
                            ${this.searchTerm ? `
                                <button class="search-clear" onclick="window.pageManager.clearSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Modes de vue -->
                    <div class="view-modes">
                        <button class="view-mode ${this.currentViewMode === 'grouped-domain' ? 'active' : ''}" 
                                onclick="window.pageManager.changeViewMode('grouped-domain')">
                            <i class="fas fa-globe"></i>
                            <span>Domaine</span>
                        </button>
                        <button class="view-mode ${this.currentViewMode === 'grouped-sender' ? 'active' : ''}" 
                                onclick="window.pageManager.changeViewMode('grouped-sender')">
                            <i class="fas fa-user"></i>
                            <span>Exp√©diteur</span>
                        </button>
                        <button class="view-mode ${this.currentViewMode === 'flat' ? 'active' : ''}" 
                                onclick="window.pageManager.changeViewMode('flat')">
                            <i class="fas fa-list"></i>
                            <span>Liste</span>
                        </button>
                    </div>
                    
                    <!-- Actions principales -->
                    <div class="action-buttons">
                        <button class="btn-action btn-selection-toggle ${allSelected ? 'all-selected' : ''}" 
                                onclick="window.pageManager.toggleAllSelection()">
                            <i class="fas ${allSelected ? 'fa-square' : 'fa-check-square'}"></i>
                            <span class="btn-text">${allSelected ? 'D√©s√©lectionner' : 'S√©lectionner'} tous</span>
                            <span class="btn-count">(${visibleEmails.length})</span>
                        </button>
                        
                        <button class="btn-action btn-primary ${selectedCount === 0 ? 'disabled' : ''}" 
                                onclick="window.pageManager.createTasksFromSelection()"
                                ${selectedCount === 0 ? 'disabled' : ''}>
                            <i class="fas fa-tasks"></i>
                            <span class="btn-text">Cr√©er t√¢che${selectedCount > 1 ? 's' : ''}</span>
                            ${selectedCount > 0 ? `<span class="count-badge">${selectedCount}</span>` : ''}
                        </button>
                        
                        ${selectedCount > 0 ? `
                            <button class="btn-action btn-clear" 
                                    onclick="window.pageManager.clearSelection()">
                                <i class="fas fa-times"></i>
                                <span class="btn-text">Effacer (${selectedCount})</span>
                            </button>
                        ` : ''}
                    </div>
                </div>

                <!-- Filtres de cat√©gories -->
                <div class="status-filters-compact">
                    ${this.buildCategoryTabs(categoryCounts, emails.length, categories)}
                </div>
            </div>
        `;
    }

    buildCategoryTabs(categoryCounts, totalEmails, categories) {
        const preselectedCategories = this.getTaskPreselectedCategories();
        
        // Ordre prioritaire avec newsletter/spam en premier
        const priorityOrder = [
            'all',
            'marketing_news',
            'spam',
            'security',
            'finance', 
            'tasks',
            'meetings',
            'commercial',
            'support',
            'hr',
            'notifications',
            'reminders',
            'project',
            'internal',
            'cc',
            'other'
        ];
        
        const tabs = [];
        
        // Onglet "Tous"
        tabs.push({
            id: 'all',
            name: 'Tous',
            icon: 'üìß',
            count: totalEmails,
            isPreselected: false,
            priority: 1000
        });
        
        // Autres onglets
        priorityOrder.slice(1).forEach(catId => {
            const count = categoryCounts[catId] || 0;
            const category = categories[catId];
            
            if (count > 0 && category) {
                const isPreselected = preselectedCategories.includes(catId);
                const priority = this.categoryPriority[catId] || 0;
                
                tabs.push({
                    id: catId,
                    name: category.name,
                    icon: category.icon,
                    color: category.color,
                    count: count,
                    isPreselected: isPreselected,
                    priority: priority,
                    specialClass: catId === 'marketing_news' ? 'newsletter-priority' : 
                                 catId === 'spam' ? 'spam-priority' : ''
                });
            }
        });
        
        // Trier par priorit√©
        tabs.sort((a, b) => (b.priority || 0) - (a.priority || 0));
        
        return tabs.map(tab => {
            const isCurrentCategory = this.currentCategory === tab.id;
            const baseClasses = `status-pill-compact ${isCurrentCategory ? 'active' : ''} ${tab.isPreselected ? 'preselected-category' : ''} ${tab.specialClass || ''}`;
            
            return `
                <button class="${baseClasses}" 
                        onclick="window.pageManager.filterByCategory('${tab.id}')"
                        data-category-id="${tab.id}"
                        title="${tab.isPreselected ? '‚≠ê Cat√©gorie pr√©-s√©lectionn√©e pour les t√¢ches' : ''}">
                    <div class="pill-content-twolines">
                        <div class="pill-first-line-twolines">
                            <span class="pill-icon-twolines">${tab.icon}</span>
                            <span class="pill-count-twolines">${tab.count}</span>
                        </div>
                        <div class="pill-second-line-twolines">
                            <span class="pill-text-twolines">${tab.name}</span>
                        </div>
                    </div>
                    ${tab.isPreselected ? '<span class="preselected-star">‚≠ê</span>' : ''}
                </button>
            `;
        }).join('');
    }

    // ================================================
    // M√âTHODES HELPER (conserv√©es mais optimis√©es)
    // ================================================
    
    getTaskPreselectedCategories() {
        // Cache la valeur pour √©viter les appels r√©p√©t√©s
        if (!this._taskPreselectedCategoriesCache) {
            if (window.categoryManager?.getTaskPreselectedCategories) {
                this._taskPreselectedCategoriesCache = window.categoryManager.getTaskPreselectedCategories();
            } else {
                try {
                    const settings = JSON.parse(localStorage.getItem('categorySettings') || '{}');
                    this._taskPreselectedCategoriesCache = settings.taskPreselectedCategories || [];
                } catch (error) {
                    this._taskPreselectedCategoriesCache = [];
                }
            }
        }
        return [...this._taskPreselectedCategoriesCache];
    }

    ensureNewsletterSpamPriority(emails) {
        // Optimis√©: traiter seulement les emails mal cat√©goris√©s
        let corrected = 0;
        
        emails.forEach(email => {
            if (email.priorityCorrection) return; // D√©j√† corrig√©
            
            const originalCategory = email.category;
            const correctedCategory = this.detectNewsletterSpamPriority(email);
            
            if (correctedCategory && correctedCategory !== originalCategory) {
                email.category = correctedCategory;
                email.categoryScore = (email.categoryScore || 0) + 100;
                email.categoryConfidence = Math.max(email.categoryConfidence || 0, 0.95);
                email.priorityCorrection = true;
                email.correctionMethod = 'priority_enhanced';
                corrected++;
            }
        });
        
        if (corrected > 0) {
            console.log(`[PageManager] ‚úÖ ${corrected} emails corrig√©s avec priorit√© Newsletter/Spam`);
        }
    }

    detectNewsletterSpamPriority(email) {
        // Cache pour √©viter recalculs
        if (email._priorityChecked) return email._priorityResult;
        
        const content = this.extractEmailContentForAnalysis(email);
        
        // Patterns newsletter
        const newsletterScore = this.calculateNewsletterScore(content);
        if (newsletterScore >= 50) {
            email._priorityChecked = true;
            email._priorityResult = 'marketing_news';
            return 'marketing_news';
        }
        
        // Patterns spam
        const spamScore = this.calculateSpamScore(content);
        if (spamScore >= 60) {
            email._priorityChecked = true;
            email._priorityResult = 'spam';
            return 'spam';
        }
        
        email._priorityChecked = true;
        email._priorityResult = null;
        return null;
    }

    calculateNewsletterScore(content) {
        let score = 0;
        
        // Patterns optimis√©s avec regex compil√©es une seule fois
        if (!this._newsletterPatterns) {
            this._newsletterPatterns = [
                /unsubscribe|d√©sabonner|opt[-\s]?out/i,
                /newsletter|mailing list/i,
                /view in browser|voir.*navigateur/i,
                /noreply@|no[-\s]?reply@|notifications@/i
            ];
        }
        
        this._newsletterPatterns.forEach(pattern => {
            if (pattern.test(content.text) || pattern.test(content.sender)) {
                score += 50;
            }
        });
        
        // Bonus domaines
        if (this.isNewsletterDomain(content.domain)) {
            score += 100;
        }
        
        return score;
    }

    calculateSpamScore(content) {
        let score = 0;
        
        if (!this._spamPatterns) {
            this._spamPatterns = [
                /urgent.*action|f√©licitations.*gagn√©|winner/i,
                /claim.*prize|free.*money|100%.*gratuit/i
            ];
        }
        
        this._spamPatterns.forEach(pattern => {
            if (pattern.test(content.text)) {
                score += 30;
            }
        });
        
        if (this.isSuspiciousDomain(content.domain)) {
            score += 50;
        }
        
        return score;
    }

    extractEmailContentForAnalysis(email) {
        // Cache pour √©viter recalculs
        if (email._extractedContent) return email._extractedContent;
        
        const subject = email.subject || '';
        const body = email.bodyPreview || email.body?.content || '';
        const sender = email.from?.emailAddress?.address || '';
        const domain = sender.includes('@') ? sender.split('@')[1] : '';
        
        email._extractedContent = {
            text: (subject + ' ' + body).toLowerCase(),
            subject: subject.toLowerCase(),
            sender: sender.toLowerCase(),
            domain: domain.toLowerCase()
        };
        
        return email._extractedContent;
    }

    isNewsletterDomain(domain) {
        if (!this._newsletterDomains) {
            this._newsletterDomains = new Set([
                'mailchimp.com', 'sendgrid.net', 'constantcontact.com',
                'aweber.com', 'getresponse.com', 'campaign-monitor.com',
                'google.com', 'microsoft.com', 'amazon.com'
            ]);
        }
        return this._newsletterDomains.has(domain);
    }

    isSuspiciousDomain(domain) {
        if (!this._suspiciousDomains) {
            this._suspiciousDomains = ['temp-mail', 'guerrillamail', 'throwaway', 'spam'];
        }
        return this._suspiciousDomains.some(suspicious => domain.includes(suspicious));
    }

    // ================================================
    // RENDU LISTE EMAILS (conserv√© mais optimis√©)
    // ================================================
    
    renderEmailsList() {
        const emails = this.getAllEmails();
        let filteredEmails = this.applyFilters(emails);
        
        if (filteredEmails.length === 0) {
            return this.renderEmptyState();
        }

        switch (this.currentViewMode) {
            case 'flat':
                return this.renderFlatView(filteredEmails);
            case 'grouped-domain':
            case 'grouped-sender':
                return this.renderGroupedView(filteredEmails, this.currentViewMode);
            default:
                return this.renderFlatView(filteredEmails);
        }
    }

    applyFilters(emails) {
        let filtered = emails;
        
        // Filtre par cat√©gorie
        if (this.currentCategory && this.currentCategory !== 'all') {
            if (this.currentCategory === 'other') {
                filtered = filtered.filter(email => {
                    const cat = email.category;
                    return !cat || cat === 'other' || cat === null || cat === undefined || cat === '';
                });
            } else {
                filtered = filtered.filter(email => email.category === this.currentCategory);
            }
        }
        
        // Filtre par recherche
        if (this.searchTerm) {
            const searchLower = this.searchTerm.toLowerCase();
            filtered = filtered.filter(email => this.matchesSearch(email, searchLower));
        }
        
        return filtered;
    }

    matchesSearch(email, searchTerm) {
        // Optimis√©: utiliser le contenu d√©j√† extrait si disponible
        const content = email._extractedContent || this.extractEmailContentForAnalysis(email);
        return content.text.includes(searchTerm) || 
               content.sender.includes(searchTerm) ||
               (email.from?.emailAddress?.name || '').toLowerCase().includes(searchTerm);
    }

    renderFlatView(emails) {
        // Utiliser un fragment pour optimiser le rendu
        return `
            <div class="tasks-harmonized-list">
                ${emails.map(email => this.renderEmailRow(email)).join('')}
            </div>
        `;
    }

    renderEmailRow(email) {
        const hasTask = this.createdTasks.has(email.id);
        const senderName = email.from?.emailAddress?.name || email.from?.emailAddress?.address || 'Inconnu';
        const senderEmail = email.from?.emailAddress?.address || '';
        
        // Optimiser la d√©tection de pr√©s√©lection
        const preselectedCategories = this.getTaskPreselectedCategories();
        const isPreselectedForTasks = email.isPreselectedForTasks || 
                                     preselectedCategories.includes(email.category);
        
        const isSelected = this.selectedEmails.has(email.id);
        
        // Classes CSS
        let specialClasses = '';
        let priorityBadge = '';
        
        if (email.category === 'marketing_news') {
            specialClasses = 'newsletter-email ultra-enhanced';
            priorityBadge = '<span class="priority-badge newsletter">üì∞ Newsletter</span>';
        } else if (email.category === 'spam') {
            specialClasses = 'spam-email ultra-enhanced';
            priorityBadge = '<span class="priority-badge spam">üö´ Spam</span>';
        } else if (email.priorityCorrection) {
            specialClasses = 'priority-corrected';
            priorityBadge = '<span class="priority-badge corrected">‚úÖ Corrig√©</span>';
        }
        
        const cardClasses = [
            'task-harmonized-card',
            'email-card-enhanced',
            isSelected ? 'selected' : '',
            hasTask ? 'has-task' : '',
            isPreselectedForTasks ? 'preselected-task' : '',
            specialClasses
        ].filter(Boolean).join(' ');
        
        return `
            <div class="${cardClasses}" 
                 data-email-id="${email.id}"
                 data-category="${email.category}"
                 data-preselected="${isPreselectedForTasks}"
                 onclick="window.pageManager.handleEmailClick(event, '${email.id}')">
                
                <input type="checkbox" 
                       class="task-checkbox-harmonized" 
                       ${isSelected ? 'checked' : ''}
                       onchange="event.stopPropagation(); window.pageManager.toggleEmailSelection('${email.id}')">
                
                <div class="priority-bar-harmonized" 
                     style="background-color: ${isPreselectedForTasks ? '#8b5cf6' : this.getEmailPriorityColor(email)}"></div>
                
                <div class="task-main-content-harmonized">
                    <div class="task-header-harmonized">
                        <h3 class="task-title-harmonized">${this.escapeHtml(email.subject || 'Sans sujet')}</h3>
                        <div class="task-meta-harmonized">
                            <span class="task-type-badge-harmonized">üìß Email</span>
                            <span class="deadline-badge-harmonized">
                                üìÖ ${this.formatEmailDate(email.receivedDateTime)}
                            </span>
                            ${email.categoryScore ? `
                                <span class="confidence-badge-harmonized">
                                    üéØ ${Math.round(email.categoryConfidence * 100)}%
                                </span>
                            ` : ''}
                            ${priorityBadge}
                            ${isPreselectedForTasks ? `
                                <span class="preselected-badge-harmonized">
                                    ‚≠ê Pr√©-s√©lectionn√©
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="task-recipient-harmonized">
                        <i class="fas fa-envelope"></i>
                        <span class="recipient-name-harmonized">${this.escapeHtml(senderName)}</span>
                        <span class="recipient-email-harmonized">${this.escapeHtml(senderEmail)}</span>
                        ${email.hasAttachments ? '<span class="attachment-indicator">üìé Pi√®ce jointe</span>' : ''}
                        ${email.category && email.category !== 'other' ? `
                            <span class="category-indicator-harmonized enhanced ${email.category === 'marketing_news' ? 'newsletter-category' : ''} ${email.category === 'spam' ? 'spam-category' : ''}" 
                                  style="background: ${this.getCategoryColor(email.category)}20; 
                                         color: ${this.getCategoryColor(email.category)};">
                                ${this.getCategoryIcon(email.category)} ${this.getCategoryName(email.category)}
                            </span>
                        ` : ''}
                    </div>
                    
                    ${email.bodyPreview ? `
                        <div class="email-preview-content">
                            <p class="preview-text">${this.escapeHtml(email.bodyPreview.substring(0, 150))}${email.bodyPreview.length > 150 ? '...' : ''}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="task-actions-harmonized">
                    ${this.renderEmailActions(email, hasTask)}
                </div>
            </div>
        `;
    }

    renderEmailActions(email, hasTask) {
        const actions = [];
        
        if (!hasTask) {
            actions.push(`
                <button class="action-btn-harmonized create-task enhanced" 
                        onclick="event.stopPropagation(); window.pageManager.showTaskCreationModal('${email.id}')"
                        title="Cr√©er une t√¢che">
                    <i class="fas fa-tasks"></i>
                </button>
            `);
        } else {
            actions.push(`
                <button class="action-btn-harmonized view-task enhanced" 
                        onclick="event.stopPropagation(); window.pageManager.openCreatedTask('${email.id}')"
                        title="Voir la t√¢che cr√©√©e">
                    <i class="fas fa-check-circle"></i>
                </button>
            `);
        }
        
        actions.push(`
            <button class="action-btn-harmonized details enhanced" 
                    onclick="event.stopPropagation(); window.pageManager.showEmailModal('${email.id}')"
                    title="Voir l'email complet">
                <i class="fas fa-eye"></i>
            </button>
        `);
        
        return actions.join('');
    }

    renderGroupedView(emails, groupMode) {
        const groups = this.createEmailGroups(emails, groupMode);
        
        return `
            <div class="tasks-grouped-harmonized">
                ${groups.map(group => this.renderEmailGroup(group, groupMode)).join('')}
            </div>
        `;
    }

    renderEmailGroup(group, groupType) {
        const displayName = groupType === 'grouped-domain' ? `@${group.name}` : group.name;
        const avatarColor = this.generateAvatarColor(group.name);
        
        return `
            <div class="task-group-harmonized" data-group-key="${group.key}">
                <div class="group-header-harmonized" onclick="event.preventDefault(); event.stopPropagation(); window.pageManager.toggleGroup('${group.key}', event)">
                    <div class="group-avatar-harmonized" style="background: ${avatarColor}">
                        ${groupType === 'grouped-domain' ? 
                            '<i class="fas fa-globe"></i>' : 
                            group.name.charAt(0).toUpperCase()
                        }
                    </div>
                    <div class="group-info-harmonized">
                        <div class="group-name-harmonized">${displayName}</div>
                        <div class="group-meta-harmonized">${group.count} email${group.count > 1 ? 's' : ''} ‚Ä¢ ${this.formatEmailDate(group.latestDate)}</div>
                    </div>
                    <div class="group-expand-harmonized">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                
                <div class="group-content-harmonized" style="display: none;">
                    ${group.emails.map(email => this.renderEmailRow(email)).join('')}
                </div>
            </div>
        `;
    }

    createEmailGroups(emails, groupMode) {
        const groups = {};
        
        emails.forEach(email => {
            let groupKey, groupName;
            
            if (groupMode === 'grouped-domain') {
                const domain = email.from?.emailAddress?.address?.split('@')[1] || 'unknown';
                groupKey = domain;
                groupName = domain;
            } else {
                const senderEmail = email.from?.emailAddress?.address || 'unknown';
                const senderName = email.from?.emailAddress?.name || senderEmail;
                groupKey = senderEmail;
                groupName = senderName;
            }
            
            if (!groups[groupKey]) {
                groups[groupKey] = {
                    key: groupKey,
                    name: groupName,
                    emails: [],
                    count: 0,
                    latestDate: null
                };
            }
            
            groups[groupKey].emails.push(email);
            groups[groupKey].count++;
            
            const emailDate = new Date(email.receivedDateTime);
            if (!groups[groupKey].latestDate || emailDate > groups[groupKey].latestDate) {
                groups[groupKey].latestDate = emailDate;
            }
        });
        
        // Trier par date la plus r√©cente
        return Object.values(groups).sort((a, b) => {
            if (!a.latestDate && !b.latestDate) return 0;
            if (!a.latestDate) return 1;
            if (!b.latestDate) return -1;
            return b.latestDate - a.latestDate;
        });
    }

    // ================================================
    // GESTION √âV√âNEMENTS OPTIMIS√âE
    // ================================================
    
    setupEventListeners() {
        // Utiliser la d√©l√©gation d'√©v√©nements pour optimiser
        document.addEventListener('click', this.handleGlobalClick.bind(this));
        
        // √âcouter les changements de param√®tres
        window.addEventListener('categorySettingsChanged', this.handleSettingsChanged.bind(this));
        window.addEventListener('settingsChanged', this.handleGenericSettingsChanged.bind(this));
        
        // √âcouter les fins de scan
        window.addEventListener('scanCompleted', this.handleScanCompleted.bind(this));
        window.addEventListener('emailsRecategorized', this.handleEmailsRecategorized.bind(this));
        
        // Scroll pour sticky controls
        window.addEventListener('scroll', this.throttle(this.handleScrollForSticky.bind(this), 100));
    }

    handleGlobalClick(event) {
        // G√©rer tous les clics de mani√®re centralis√©e
        const target = event.target;
        
        // Ne rien faire si pas sur la page emails
        if (this.currentPage !== 'emails') return;
        
        // G√©rer les diff√©rents types de clics
        if (target.closest('.task-harmonized-card')) {
            const card = target.closest('.task-harmonized-card');
            const emailId = card.dataset.emailId;
            
            if (target.type === 'checkbox') {
                // D√©j√† g√©r√© par onchange
                return;
            }
            
            if (target.closest('.task-actions-harmonized')) {
                // Les boutons d'action ont leurs propres handlers
                return;
            }
            
            // Clic sur la carte
            this.handleEmailClick(event, emailId);
        }
    }

    handleSettingsChanged(event) {
        const settingsData = event.detail;
        
        // Invalider le cache des cat√©gories pr√©-s√©lectionn√©es
        this._taskPreselectedCategoriesCache = null;
        
        if (settingsData.settings?.taskPreselectedCategories) {
            console.log('[PageManager] üìã Cat√©gories pr√©-s√©lectionn√©es chang√©es');
            
            // Forcer une re-cat√©gorisation si n√©cessaire
            if (window.emailScanner && this.emailsCache.processedEmails.length > 0) {
                setTimeout(() => {
                    if (typeof window.emailScanner.recategorizeEmails === 'function') {
                        window.emailScanner.recategorizeEmails();
                    }
                }, 100);
            }
        }
        
        if (this.currentPage === 'emails') {
            setTimeout(() => {
                this.refreshEmailsView();
            }, 200);
        }
    }

    handleGenericSettingsChanged(event) {
        const { type, value } = event.detail;
        
        if (type === 'taskPreselectedCategories' || type === 'activeCategories') {
            this._taskPreselectedCategoriesCache = null;
            
            if (this.currentPage === 'emails') {
                this.refreshEmailsView();
            }
        }
    }

    handleScanCompleted(event) {
        const eventDetail = event.detail;
        this.lastScanData = eventDetail;
        
        if (eventDetail.emails && Array.isArray(eventDetail.emails)) {
            this.updateEmailsCache(eventDetail.emails, 'scan_completed');
        }
        
        // Rafra√Æchir la vue si on est sur la page emails
        if (this.currentPage === 'emails') {
            setTimeout(() => {
                this.loadPage('emails');
            }, 100);
        }
    }

    handleEmailsRecategorized(event) {
        const eventDetail = event.detail;
        
        if (eventDetail && eventDetail.emails) {
            this.updateEmailsCache(eventDetail.emails, 'recategorized');
        }
        
        if (this.currentPage === 'emails') {
            setTimeout(() => {
                this.refreshEmailsView();
            }, 100);
        }
    }

    // ================================================
    // M√âTHODES INTERACTION
    // ================================================
    
    handleEmailClick(event, emailId) {
        // Gestion optimis√©e des clics
        if (event.target.type === 'checkbox' || 
            event.target.closest('.task-actions-harmonized')) {
            return;
        }
        
        // Double-clic pour s√©lection
        const now = Date.now();
        const lastClick = this.lastEmailClick || 0;
        
        if (now - lastClick < 300 && this.lastClickedEmail === emailId) {
            // Double-clic
            event.preventDefault();
            event.stopPropagation();
            this.toggleEmailSelection(emailId);
            this.lastEmailClick = 0;
            this.lastClickedEmail = null;
        } else {
            // Simple clic
            this.lastEmailClick = now;
            this.lastClickedEmail = emailId;
            
            setTimeout(() => {
                if (Date.now() - this.lastEmailClick >= 250 && this.lastClickedEmail === emailId) {
                    this.showEmailModal(emailId);
                }
            }, 250);
        }
    }

    toggleEmailSelection(emailId) {
        if (this.selectedEmails.has(emailId)) {
            this.selectedEmails.delete(emailId);
        } else {
            this.selectedEmails.add(emailId);
        }
        
        this.updateEmailCard(emailId);
        this.updateControlsBarOnly();
    }

    updateEmailCard(emailId) {
        const card = document.querySelector(`[data-email-id="${emailId}"]`);
        if (!card) return;
        
        const checkbox = card.querySelector('.task-checkbox-harmonized');
        const isSelected = this.selectedEmails.has(emailId);
        
        if (checkbox) {
            checkbox.checked = isSelected;
        }
        
        if (isSelected) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    }

    toggleAllSelection() {
        const visibleEmails = this.getVisibleEmails();
        const allSelected = visibleEmails.length > 0 && 
                           visibleEmails.every(email => this.selectedEmails.has(email.id));
        
        if (allSelected) {
            // D√©s√©lectionner tous
            visibleEmails.forEach(email => {
                this.selectedEmails.delete(email.id);
                this.updateEmailCard(email.id);
            });
            window.uiManager?.showToast(`${visibleEmails.length} emails d√©s√©lectionn√©s`, 'info');
        } else {
            // S√©lectionner tous
            visibleEmails.forEach(email => {
                this.selectedEmails.add(email.id);
                this.updateEmailCard(email.id);
            });
            window.uiManager?.showToast(`${visibleEmails.length} emails s√©lectionn√©s`, 'success');
        }
        
        this.updateControlsBarOnly();
    }

    clearSelection() {
        this.selectedEmails.forEach(emailId => {
            this.updateEmailCard(emailId);
        });
        this.selectedEmails.clear();
        this.updateControlsBarOnly();
        window.uiManager?.showToast('S√©lection effac√©e', 'info');
    }

    getVisibleEmails() {
        const emails = this.getAllEmails();
        return this.applyFilters(emails);
    }

    getAllEmails() {
        return this.emailsCache.processedEmails;
    }

    // ================================================
    // FILTRES ET RECHERCHE
    // ================================================
    
    filterByCategory(categoryId) {
        console.log(`[PageManager] üîç Filtrage par cat√©gorie: ${categoryId}`);
        
        this.currentCategory = categoryId;
        this.refreshEmailsView();
        
        // Mettre √† jour l'UI
        this.updateCategoryTabs(categoryId);
    }

    updateCategoryTabs(activeCategory) {
        document.querySelectorAll('.status-pill-compact').forEach(pill => {
            if (pill.dataset.categoryId === activeCategory) {
                pill.classList.add('active');
            } else {
                pill.classList.remove('active');
            }
        });
    }

    changeViewMode(mode) {
        this.currentViewMode = mode;
        this.refreshEmailsView();
        
        // Mettre √† jour les boutons
        document.querySelectorAll('.view-mode').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeBtn = document.querySelector(`.view-mode[onclick*="${mode}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }

    handleSearch(term) {
        this.searchTerm = term.trim();
        this.refreshEmailsView();
    }

    clearSearch() {
        this.searchTerm = '';
        const searchInput = document.getElementById('emailSearchInput');
        if (searchInput) searchInput.value = '';
        this.refreshEmailsView();
    }

    setupEmailsEventListeners() {
        const searchInput = document.getElementById('emailSearchInput');
        if (searchInput) {
            // Debounce search
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.handleSearch(e.target.value);
                }, 300);
            });
        }
    }

    // ================================================
    // STICKY CONTROLS
    // ================================================
    
    setupStickyControls() {
        const originalContainer = document.querySelector('.controls-and-filters-container');
        const stickyContainer = document.querySelector('.sticky-controls-container');
        
        if (!originalContainer || !stickyContainer) return;

        // Cloner le contenu
        stickyContainer.innerHTML = originalContainer.innerHTML;
        
        // R√©attacher les √©v√©nements sur le clone
        this.setupEventListenersForClone(stickyContainer);
    }

    setupEventListenersForClone(container) {
        // Search
        const searchInput = container.querySelector('#emailSearchInput');
        if (searchInput) {
            searchInput.id = 'emailSearchInputSticky';
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.handleSearch(e.target.value);
                    // Synchroniser avec l'input original
                    const originalInput = document.getElementById('emailSearchInput');
                    if (originalInput) originalInput.value = e.target.value;
                }, 300);
            });
        }
        
        // R√©attacher tous les onclick
        container.querySelectorAll('[onclick]').forEach(element => {
            const onclickAttr = element.getAttribute('onclick');
            element.removeAttribute('onclick');
            element.addEventListener('click', () => {
                eval(onclickAttr);
            });
        });
    }

    handleScrollForSticky() {
        if (this.currentPage !== 'emails') return;

        const stickyContainer = document.querySelector('.sticky-controls-container');
        const originalContainer = document.querySelector('.controls-and-filters-container');
        
        if (!stickyContainer || !originalContainer) return;

        const scrollY = window.scrollY;
        const containerTop = originalContainer.offsetTop;
        
        if (scrollY > containerTop - 20) {
            stickyContainer.classList.add('sticky-active');
        } else {
            stickyContainer.classList.remove('sticky-active');
        }
    }

    updateControlsBarOnly() {
        const selectedCount = this.selectedEmails.size;
        const visibleEmails = this.getVisibleEmails();
        const allSelected = visibleEmails.length > 0 && 
                           visibleEmails.every(email => this.selectedEmails.has(email.id));
        
        // Mettre √† jour les deux barres de contr√¥le (normale et sticky)
        ['', 'Sticky'].forEach(suffix => {
            const container = suffix ? 
                document.querySelector('.sticky-controls-container') : 
                document.querySelector('.controls-and-filters-container');
            
            if (!container) return;
            
            // Bouton s√©lection tous
            const selectAllBtn = container.querySelector('.btn-selection-toggle');
            if (selectAllBtn) {
                const btnText = selectAllBtn.querySelector('.btn-text');
                const btnCount = selectAllBtn.querySelector('.btn-count');
                const icon = selectAllBtn.querySelector('i');
                
                if (allSelected) {
                    selectAllBtn.classList.add('all-selected');
                    if (btnText) btnText.textContent = 'D√©s√©lectionner tous';
                    if (icon) {
                        icon.classList.remove('fa-check-square');
                        icon.classList.add('fa-square');
                    }
                } else {
                    selectAllBtn.classList.remove('all-selected');
                    if (btnText) btnText.textContent = 'S√©lectionner tous';
                    if (icon) {
                        icon.classList.remove('fa-square');
                        icon.classList.add('fa-check-square');
                    }
                }
                
                if (btnCount) {
                    btnCount.textContent = `(${visibleEmails.length})`;
                }
            }
            
            // Bouton cr√©er t√¢ches
            const createTaskBtn = container.querySelector('.btn-primary[onclick*="createTasksFromSelection"]');
            if (createTaskBtn) {
                const span = createTaskBtn.querySelector('.btn-text');
                let countBadge = createTaskBtn.querySelector('.count-badge');
                
                if (selectedCount === 0) {
                    createTaskBtn.classList.add('disabled');
                    createTaskBtn.disabled = true;
                } else {
                    createTaskBtn.classList.remove('disabled');
                    createTaskBtn.disabled = false;
                }
                
                if (span) {
                    span.textContent = `Cr√©er t√¢che${selectedCount > 1 ? 's' : ''}`;
                }
                
                if (selectedCount > 0) {
                    if (!countBadge) {
                        countBadge = document.createElement('span');
                        countBadge.className = 'count-badge';
                        createTaskBtn.appendChild(countBadge);
                    }
                    countBadge.textContent = selectedCount;
                    countBadge.style.display = 'inline';
                } else if (countBadge) {
                    countBadge.style.display = 'none';
                }
            }
            
            // Bouton effacer
            const clearBtnContainer = container.querySelector('.action-buttons');
            let clearBtn = container.querySelector('.btn-clear');
            
            if (selectedCount > 0 && !clearBtn && clearBtnContainer) {
                clearBtn = document.createElement('button');
                clearBtn.className = 'btn-action btn-clear';
                clearBtn.innerHTML = `
                    <i class="fas fa-times"></i>
                    <span class="btn-text">Effacer (${selectedCount})</span>
                `;
                clearBtn.onclick = () => this.clearSelection();
                clearBtnContainer.appendChild(clearBtn);
            } else if (clearBtn) {
                if (selectedCount > 0) {
                    const span = clearBtn.querySelector('.btn-text');
                    if (span) span.textContent = `Effacer (${selectedCount})`;
                } else {
                    clearBtn.remove();
                }
            }
        });
    }

    refreshEmailsView() {
        console.log('[PageManager] üîÑ Rafra√Æchissement vue emails...');
        
        const emailsContainer = document.querySelector('.tasks-container-harmonized');
        if (emailsContainer) {
            // Utiliser requestAnimationFrame pour optimiser
            requestAnimationFrame(() => {
                emailsContainer.innerHTML = this.renderEmailsList();
            });
        }
        
        this.updateControlsBarOnly();
    }

    // ================================================
    // MODAL EMAIL
    // ================================================
    
    showEmailModal(emailId) {
        const email = this.getEmailById(emailId);
        if (!email) {
            console.error('[PageManager] Email non trouv√©:', emailId);
            window.uiManager?.showToast('Email non trouv√©', 'error');
            return;
        }

        // Supprimer modals existantes
        document.querySelectorAll('.modal-overlay').forEach(el => el.remove());
        
        const modal = this.createEmailModal(email);
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Focus management
        const closeBtn = modal.querySelector('.modal-close-btn');
        if (closeBtn) closeBtn.focus();
    }

    createEmailModal(email) {
        const providerInfo = this.getProviderInfo();
        const uniqueId = 'email_modal_' + Date.now();
        
        const modal = document.createElement('div');
        modal.id = uniqueId;
        modal.className = 'modal-overlay';
        modal.innerHTML = this.renderEmailModalContent(email, providerInfo);
        
        // Event handlers
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeModal(modal);
            }
        });
        
        // ESC key
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                this.closeModal(modal);
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        return modal;
    }

    renderEmailModalContent(email, providerInfo) {
        const senderName = email.from?.emailAddress?.name || 'Inconnu';
        const senderEmail = email.from?.emailAddress?.address || '';
        const categoryInfo = this.getCategoryInfo(email.category);
        
        return `
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header-info">
                        <h2 class="modal-title">Email Complet</h2>
                        <div class="modal-badges">
                            <span class="provider-badge" style="background: ${providerInfo.color}">
                                <i class="${providerInfo.icon}"></i> ${providerInfo.name}
                            </span>
                            ${categoryInfo ? `
                                <span class="category-badge" style="background: ${categoryInfo.color}20; color: ${categoryInfo.color}">
                                    ${categoryInfo.icon} ${categoryInfo.name}
                                </span>
                            ` : ''}
                            ${email.category === 'marketing_news' ? '<span class="special-badge newsletter">üì∞ Newsletter</span>' : ''}
                            ${email.category === 'spam' ? '<span class="special-badge spam">üö´ Spam</span>' : ''}
                        </div>
                    </div>
                    <button class="modal-close-btn" onclick="window.pageManager.closeCurrentModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="email-info-section">
                        <h3>Informations de l'email</h3>
                        <div class="email-info-grid">
                            <div class="info-row">
                                <span class="info-label">De:</span>
                                <div class="info-value">
                                    <div class="sender-name">${this.escapeHtml(senderName)}</div>
                                    <div class="sender-email">&lt;${this.escapeHtml(senderEmail)}&gt;</div>
                                </div>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date:</span>
                                <span class="info-value">${new Date(email.receivedDateTime).toLocaleString('fr-FR')}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Sujet:</span>
                                <span class="info-value subject">${this.escapeHtml(email.subject || 'Sans sujet')}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${this.renderEmailAnalysisInfo(email)}
                    
                    <div class="email-content-section">
                        <h3>Contenu de l'email</h3>
                        <div class="email-content">
                            ${this.getEmailContentForModal(email)}
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn secondary" onclick="window.pageManager.closeCurrentModal()">
                        Fermer
                    </button>
                    ${!this.createdTasks.has(email.id) ? `
                        <button class="modal-btn primary" onclick="window.pageManager.closeCurrentModal(); window.pageManager.showTaskCreationModal('${email.id}')">
                            <i class="fas fa-tasks"></i> Cr√©er une t√¢che
                        </button>
                    ` : `
                        <button class="modal-btn success" onclick="window.pageManager.closeCurrentModal(); window.pageManager.openCreatedTask('${email.id}')">
                            <i class="fas fa-check-circle"></i> Voir la t√¢che
                        </button>
                    `}
                </div>
            </div>
        `;
    }

    renderEmailAnalysisInfo(email) {
        if (!email.categoryScore) return '';
        
        return `
            <div class="email-analysis-section">
                <h3><i class="fas fa-brain"></i> Analyse IA</h3>
                <div class="analysis-grid">
                    <div class="analysis-item">
                        <span class="analysis-label">Score:</span>
                        <span class="analysis-value score">${email.categoryScore || 0} points</span>
                    </div>
                    <div class="analysis-item">
                        <span class="analysis-label">Confiance:</span>
                        <span class="analysis-value confidence">${Math.round((email.categoryConfidence || 0) * 100)}%</span>
                    </div>
                    ${email.matchedPatterns && email.matchedPatterns.length > 0 ? `
                        <div class="analysis-item patterns">
                            <span class="analysis-label">Patterns:</span>
                            <div class="patterns-list">
                                ${email.matchedPatterns.slice(0, 5).map(p => 
                                    `<span class="pattern-tag">${this.escapeHtml(p.keyword || p)}</span>`
                                ).join('')}
                                ${email.matchedPatterns.length > 5 ? `<span class="more-patterns">+${email.matchedPatterns.length - 5}</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    getEmailContentForModal(email) {
        let content = '';
        
        if (email.body?.content) {
            content = email.body.content;
            if (content.includes('<')) {
                content = this.cleanHtmlForDisplay(content);
            } else {
                content = `<p>${this.escapeHtml(content)}</p>`;
            }
        } else if (email.bodyPreview) {
            content = `<p><em>Aper√ßu:</em></p><p>${this.escapeHtml(email.bodyPreview)}</p>`;
        } else {
            content = '<p><em>Aucun contenu disponible</em></p>';
        }
        
        return content;
    }

    cleanHtmlForDisplay(html) {
        // Nettoyer le HTML de mani√®re s√©curis√©e
        const cleaned = html
            .replace(/<script[^>]*>.*?<\/script>/gis, '')
            .replace(/<style[^>]*>.*?<\/style>/gis, '')
            .replace(/<iframe[^>]*>.*?<\/iframe>/gis, '')
            .replace(/on\w+="[^"]*"/gi, '')
            .replace(/javascript:/gi, '');
        
        return cleaned;
    }

    closeModal(modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
    }

    closeCurrentModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) this.closeModal(modal);
    }

    // ================================================
    // CR√âATION DE T√ÇCHES
    // ================================================
    
    async createTasksFromSelection() {
        if (this.selectedEmails.size === 0) {
            window.uiManager?.showToast('Aucun email s√©lectionn√©', 'warning');
            return;
        }
        
        let created = 0;
        const total = this.selectedEmails.size;
        
        window.uiManager?.showLoading(`Cr√©ation de ${total} t√¢ches...`);
        
        for (const emailId of this.selectedEmails) {
            const email = this.getEmailById(emailId);
            if (!email || this.createdTasks.has(emailId)) continue;
            
            try {
                if (window.taskManager) {
                    const taskData = this.buildTaskFromEmail(email);
                    const task = window.taskManager.createTaskFromEmail(taskData, email);
                    this.createdTasks.set(emailId, task.id);
                    created++;
                    
                    // Mettre √† jour progress
                    if (window.uiManager?.updateLoadingMessage) {
                        window.uiManager.updateLoadingMessage(`Cr√©ation: ${created}/${total}`);
                    }
                }
            } catch (error) {
                console.error('[PageManager] Erreur cr√©ation t√¢che:', emailId, error);
            }
        }
        
        window.uiManager?.hideLoading();
        
        if (created > 0) {
            window.taskManager?.saveTasks();
            window.uiManager?.showToast(`${created} t√¢che${created > 1 ? 's' : ''} cr√©√©e${created > 1 ? 's' : ''}`, 'success');
            this.clearSelection();
            this.refreshEmailsView();
        } else {
            window.uiManager?.showToast('Aucune t√¢che cr√©√©e', 'warning');
        }
    }

    buildTaskFromEmail(email) {
        const senderName = email.from?.emailAddress?.name || 'Inconnu';
        const senderEmail = email.from?.emailAddress?.address || '';
        const senderDomain = senderEmail.split('@')[1] || 'unknown';
        
        return {
            id: this.generateTaskId(),
            title: `Email de ${senderName}: ${email.subject || 'Sans sujet'}`,
            description: this.buildTaskDescription(email),
            priority: this.determinePriority(email),
            dueDate: null,
            status: 'todo',
            emailId: email.id,
            category: email.category || 'other',
            createdAt: new Date().toISOString(),
            emailFrom: senderEmail,
            emailFromName: senderName,
            emailSubject: email.subject,
            emailDomain: senderDomain,
            emailDate: email.receivedDateTime,
            hasAttachments: email.hasAttachments || false,
            tags: [senderDomain, email.category].filter(Boolean),
            method: 'enhanced',
            provider: this.currentProvider || 'unknown',
            categoryScore: email.categoryScore || 0,
            categoryConfidence: email.categoryConfidence || 0,
            detectionMethod: email.detectionMethod || 'standard',
            priorityCorrection: email.priorityCorrection || false
        };
    }

    buildTaskDescription(email) {
        let description = email.bodyPreview || 'Aucune description disponible';
        
        const contextInfo = [];
        
        if (email.category && email.category !== 'other') {
            contextInfo.push(`Cat√©gorie: ${this.getCategoryName(email.category)}`);
        }
        
        if (email.hasAttachments) {
            contextInfo.push('Contient des pi√®ces jointes');
        }
        
        if (email.importance === 'high') {
            contextInfo.push('Marqu√© comme important');
        }
        
        if (contextInfo.length > 0) {
            description += '\n\n--- Informations ---\n' + contextInfo.join('\n');
        }
        
        return description;
    }

    determinePriority(email) {
        if (email.importance === 'high') return 'urgent';
        if (['security', 'finance', 'tasks'].includes(email.category)) return 'high';
        if (email.categoryScore > 120) return 'high';
        if (email.category === 'meetings') return 'medium';
        if (['marketing_news', 'notifications'].includes(email.category)) return 'low';
        
        return 'medium';
    }

    generateTaskId() {
        return `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    async showTaskCreationModal(emailId) {
        const email = this.getEmailById(emailId);
        if (!email) {
            window.uiManager?.showToast('Email non trouv√©', 'error');
            return;
        }

        // TODO: Impl√©menter la modal de cr√©ation de t√¢che
        // Pour l'instant, cr√©ation directe
        try {
            const taskData = this.buildTaskFromEmail(email);
            const task = window.taskManager?.createTaskFromEmail(taskData, email);
            
            if (task) {
                this.createdTasks.set(emailId, task.id);
                window.taskManager?.saveTasks();
                window.uiManager?.showToast('T√¢che cr√©√©e avec succ√®s', 'success');
                this.refreshEmailsView();
            }
        } catch (error) {
            console.error('[PageManager] Erreur cr√©ation t√¢che:', error);
            window.uiManager?.showToast('Erreur lors de la cr√©ation', 'error');
        }
    }

    openCreatedTask(emailId) {
        const taskId = this.createdTasks.get(emailId);
        if (!taskId) return;
        
        this.loadPage('tasks').then(() => {
            setTimeout(() => {
                if (window.tasksView?.showTaskDetails) {
                    window.tasksView.showTaskDetails(taskId);
                }
            }, 100);
        });
    }

    // ================================================
    // M√âTHODES UTILITAIRES
    // ================================================
    
    getCategoryInfo(categoryId) {
        if (!categoryId) return null;
        
        const category = window.categoryManager?.getCategory(categoryId);
        if (!category) return null;
        
        return {
            id: categoryId,
            name: category.name,
            icon: category.icon,
            color: category.color
        };
    }

    getCategoryColor(categoryId) {
        return this.getCategoryInfo(categoryId)?.color || '#64748b';
    }

    getCategoryIcon(categoryId) {
        return this.getCategoryInfo(categoryId)?.icon || 'üìå';
    }

    getCategoryName(categoryId) {
        return this.getCategoryInfo(categoryId)?.name || categoryId || 'Autre';
    }

    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatEmailDate(dateString) {
        if (!dateString) return '';
        
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            if (diffHours === 0) {
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                return diffMinutes === 0 ? '√Ä l\'instant' : `Il y a ${diffMinutes} min`;
            }
            return `Il y a ${diffHours}h`;
        } else if (diffDays === 1) {
            return 'Hier';
        } else if (diffDays < 7) {
            return `Il y a ${diffDays} jours`;
        } else {
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }
    }

    getEmailPriorityColor(email) {
        if (email.importance === 'high') return '#ef4444';
        if (email.hasAttachments) return '#f97316';
        if (email.categoryScore >= 80) return '#10b981';
        if (email.category === 'marketing_news') return '#f97316';
        if (email.category === 'spam') return '#ef4444';
        return '#3b82f6';
    }

    generateAvatarColor(text) {
        let hash = 0;
        for (let i = 0; i < text.length; i++) {
            hash = text.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const hue = Math.abs(hash) % 360;
        const saturation = 65 + (Math.abs(hash) % 20);
        const lightness = 45 + (Math.abs(hash) % 15);
        
        return `linear-gradient(135deg, hsl(${hue}, ${saturation}%, ${lightness}%), hsl(${(hue + 30) % 360}, ${saturation}%, ${lightness + 10}%))`;
    }

    hideExplanationMessage() {
        this.hideExplanation = true;
        localStorage.setItem('hideEmailExplanation', 'true');
        this.refreshEmailsView();
    }

    scheduleAutoAnalysis(emails) {
        // Analyser seulement les premiers emails pr√©-s√©lectionn√©s
        const preselectedCategories = this.getTaskPreselectedCategories();
        if (!preselectedCategories.length) return;
        
        const emailsToAnalyze = emails
            .filter(email => preselectedCategories.includes(email.category))
            .slice(0, 3); // Limiter √† 3 pour performance
        
        if (emailsToAnalyze.length > 0) {
            setTimeout(() => {
                this.analyzeFirstEmails(emailsToAnalyze);
            }, 1000);
        }
    }

    analyzeFirstEmails(emails) {
        console.log(`[PageManager] ü§ñ Analyse automatique de ${emails.length} emails`);
        // TODO: Impl√©menter l'analyse IA si n√©cessaire
    }

    // ================================================
    // NAVIGATION ET PAGES
    // ================================================
    
    async loadPage(pageName) {
        console.log(`[PageManager] üìÑ Chargement page: ${pageName}`);

        if (pageName === 'dashboard') {
            console.log('[PageManager] Dashboard g√©r√© par index.html');
            this.updateNavigation(pageName);
            return;
        }

        const pageContent = document.getElementById('pageContent');
        if (!pageContent) {
            console.error('[PageManager] Container de contenu non trouv√©');
            return;
        }

        this.updateNavigation(pageName);
        window.uiManager?.showLoading(`Chargement ${pageName}...`);

        try {
            pageContent.innerHTML = '';
            
            if (this.pages[pageName]) {
                await this.pages[pageName](pageContent);
                this.currentPage = pageName;
            } else {
                throw new Error(`Page ${pageName} non trouv√©e`);
            }

            window.uiManager?.hideLoading();

        } catch (error) {
            console.error(`[PageManager] Erreur chargement page:`, error);
            window.uiManager?.hideLoading();
            window.uiManager?.showToast(`Erreur: ${error.message}`, 'error');
            
            pageContent.innerHTML = this.renderErrorPage(error);
        }
    }

    updateNavigation(activePage) {
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.page === activePage) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    // ================================================
    // RENDU DES AUTRES PAGES
    // ================================================
    
    async renderScanner(container) {
        if (window.scanStartModule?.render) {
            try {
                await window.scanStartModule.render(container);
            } catch (error) {
                console.error('[PageManager] Erreur rendu scanner:', error);
                container.innerHTML = this.renderScannerFallback();
            }
        } else {
            container.innerHTML = this.renderScannerFallback();
        }
    }

    renderScannerFallback() {
        const providerInfo = this.getProviderInfo();
        
        return `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3 class="empty-title">Scanner d'emails</h3>
                <p class="empty-text">
                    ${providerInfo.status === 'connected' ? 
                        `Connect√© √† ${providerInfo.name}. Module de scan en cours de chargement...` :
                        'Connectez-vous √† Gmail ou Outlook pour commencer.'
                    }
                </p>
            </div>
        `;
    }

    async renderTasks(container) {
        if (window.tasksView?.render) {
            window.tasksView.render(container);
        } else {
            container.innerHTML = `
                <div class="page-header">
                    <h1>T√¢ches</h1>
                </div>
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h3 class="empty-title">Aucune t√¢che</h3>
                    <p class="empty-text">Cr√©ez des t√¢ches √† partir de vos emails</p>
                </div>
            `;
        }
    }

    async renderCategories(container) {
        const categories = window.categoryManager?.getCategories() || {};
        
        container.innerHTML = `
            <div class="page-header">
                <h1>Cat√©gories</h1>
            </div>
            
            <div class="categories-grid">
                ${Object.entries(categories).map(([id, cat]) => `
                    <div class="category-card">
                        <div class="category-icon" style="background: ${cat.color}20; color: ${cat.color}">
                            ${cat.icon}
                        </div>
                        <h3>${cat.name}</h3>
                        <p>${cat.description || ''}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }

    async renderSettings(container) {
        if (window.categoriesPage?.renderSettings) {
            window.categoriesPage.renderSettings(container);
        } else {
            container.innerHTML = `
                <div class="page-header">
                    <h1>Param√®tres</h1>
                </div>
                <div class="settings-card">
                    <p>Configuration en cours de chargement...</p>
                </div>
            `;
        }
    }

    async renderRanger(container) {
        if (window.domainOrganizer?.showPage) {
            window.domainOrganizer.showPage(container);
        } else {
            container.innerHTML = `
                <div class="page-header">
                    <h1>Ranger par domaine</h1>
                </div>
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-folder-tree"></i>
                    </div>
                    <h3 class="empty-title">Module de rangement</h3>
                    <p class="empty-text">Module en cours de chargement...</p>
                </div>
            `;
        }
    }

    // ================================================
    // √âTATS VIDES
    // ================================================
    
    renderEmptyEmailsState() {
        const providerInfo = this.getProviderInfo();
        
        return `
            <div class="tasks-page-modern">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3 class="empty-state-title">Aucun email trouv√©</h3>
                    <p class="empty-state-text">
                        ${providerInfo.status === 'connected' ? 
                            `Connect√© √† ${providerInfo.name}. Lancez un scan pour r√©cup√©rer vos emails.` :
                            'Connectez-vous √† Gmail ou Outlook pour commencer.'
                        }
                    </p>
                    <div class="empty-state-actions">
                        ${providerInfo.status === 'connected' ? `
                            <button class="btn btn-primary" onclick="window.pageManager.loadPage('scanner')">
                                <i class="fas fa-search"></i>
                                Aller au scanner
                            </button>
                            <button class="btn btn-secondary" onclick="window.pageManager.refreshEmails()">
                                <i class="fas fa-sync-alt"></i>
                                Scan rapide
                            </button>
                        ` : `
                            <button class="btn btn-primary" onclick="window.googleAuthService?.login()" style="background: #ea4335;">
                                <i class="fab fa-google"></i>
                                Se connecter √† Gmail
                            </button>
                            <button class="btn btn-secondary" onclick="window.authService?.login()" style="background: #0078d4; color: white;">
                                <i class="fab fa-microsoft"></i>
                                Se connecter √† Outlook
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    renderEmptyState() {
        const providerInfo = this.getProviderInfo();
        
        let title, text, action = '';
        
        if (this.searchTerm) {
            title = 'Aucun r√©sultat trouv√©';
            text = `Aucun email ne correspond √† votre recherche "${this.searchTerm}"`;
            action = `
                <button class="btn btn-primary" onclick="window.pageManager.clearSearch()">
                    <i class="fas fa-undo"></i>
                    <span>Effacer la recherche</span>
                </button>
            `;
        } else if (this.currentCategory && this.currentCategory !== 'all') {
            const categoryName = this.getCategoryName(this.currentCategory);
            title = `Aucun email dans "${categoryName}"`;
            text = 'Cette cat√©gorie ne contient aucun email.';
            action = `
                <button class="btn btn-primary" onclick="window.pageManager.filterByCategory('all')">
                    <i class="fas fa-list"></i>
                    <span>Voir tous les emails</span>
                </button>
            `;
        } else {
            title = 'Aucun email';
            text = 'Aucun email ne correspond aux crit√®res.';
        }
        
        return `
            <div class="empty-state-harmonized">
                <div class="empty-state-icon-harmonized">
                    <i class="fas fa-inbox"></i>
                </div>
                <h3 class="empty-state-title-harmonized">${title}</h3>
                <p class="empty-state-text-harmonized">${text}</p>
                ${action}
            </div>
        `;
    }

    renderErrorPage(error) {
        return `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="empty-state-title">Erreur de chargement</h3>
                <p class="empty-state-text">${error.message}</p>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    Recharger la page
                </button>
            </div>
        `;
    }

    // ================================================
    // STYLES CSS
    // ================================================
    
    addEmailStyles() {
        if (document.getElementById('emailPageStyles')) return;
        
        const styles = document.createElement('style');
        styles.id = 'emailPageStyles';
        styles.textContent = this.getEmailStyles();
        document.head.appendChild(styles);
    }

    getEmailStyles() {
        // Retourner les styles CSS optimis√©s
        return `
            /* PageManager v15.0 - Styles optimis√©s */
            
            /* Modal styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.75);
                z-index: 99999999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                backdrop-filter: blur(4px);
                animation: fadeIn 0.2s ease-out;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .modal-content {
                background: white;
                border-radius: 16px;
                max-width: 900px;
                width: 100%;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
            }
            
            @keyframes slideIn {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .modal-header {
                padding: 24px;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
            }
            
            .modal-header-info {
                flex: 1;
            }
            
            .modal-title {
                margin: 0;
                font-size: 24px;
                font-weight: 700;
                color: #1f2937;
            }
            
            .modal-badges {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 8px;
            }
            
            .provider-badge,
            .category-badge,
            .special-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
            }
            
            .provider-badge {
                color: white;
            }
            
            .category-badge {
                border: 1px solid;
            }
            
            .special-badge.newsletter {
                background: linear-gradient(135deg, #f97316, #ea580c);
                color: white;
            }
            
            .special-badge.spam {
                background: linear-gradient(135deg, #ef4444, #dc2626);
                color: white;
            }
            
            .modal-close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #6b7280;
                padding: 0;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                transition: all 0.2s ease;
            }
            
            .modal-close-btn:hover {
                background: #f3f4f6;
                color: #374151;
            }
            
            .modal-body {
                padding: 24px;
                overflow-y: auto;
                flex: 1;
            }
            
            .email-info-section,
            .email-analysis-section,
            .email-content-section {
                margin-bottom: 24px;
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 20px;
            }
            
            .email-info-section h3,
            .email-analysis-section h3,
            .email-content-section h3 {
                margin: 0 0 16px 0;
                font-size: 18px;
                font-weight: 700;
                color: #374151;
            }
            
            .email-info-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .info-row {
                display: flex;
                align-items: flex-start;
                gap: 12px;
            }
            
            .info-label {
                font-weight: 700;
                color: #374151;
                min-width: 80px;
            }
            
            .info-value {
                flex: 1;
                color: #1f2937;
            }
            
            .sender-name {
                font-weight: 600;
            }
            
            .sender-email {
                font-size: 14px;
                color: #6b7280;
                font-family: monospace;
            }
            
            .info-value.subject {
                font-weight: 600;
                word-break: break-word;
            }
            
            .analysis-grid {
                display: grid;
                gap: 12px;
            }
            
            .analysis-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .analysis-label {
                font-weight: 600;
                color: #374151;
            }
            
            .analysis-value {
                font-weight: 700;
            }
            
            .analysis-value.score {
                background: #10b981;
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
            }
            
            .analysis-value.confidence {
                background: #3b82f6;
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
            }
            
            .patterns-list {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .pattern-tag {
                background: #f3f4f6;
                color: #374151;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 11px;
                font-family: monospace;
            }
            
            .more-patterns {
                color: #6b7280;
                font-size: 12px;
            }
            
            .email-content {
                max-height: 400px;
                overflow-y: auto;
                padding: 12px;
                background: white;
                border-radius: 8px;
                line-height: 1.6;
                color: #374151;
                word-break: break-word;
            }
            
            .modal-footer {
                padding: 24px;
                border-top: 1px solid #e5e7eb;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
            }
            
            .modal-btn {
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 14px;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            
            .modal-btn.secondary {
                background: #f3f4f6;
                color: #374151;
                border: 1px solid #d1d5db;
            }
            
            .modal-btn.secondary:hover {
                background: #e5e7eb;
            }
            
            .modal-btn.primary {
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
            }
            
            .modal-btn.primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }
            
            .modal-btn.success {
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
            }
            
            .modal-btn.success:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }
            
            /* Cache status styles */
            .cache-age {
                font-size: 11px;
                color: #6b7280;
                margin-left: 4px;
            }
            
            .source-indicator {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 600;
                background: rgba(99, 102, 241, 0.1);
                border: 1px solid #6366f1;
                color: #4f46e5;
            }
            
            /* Optimisations pour performance */
            .task-harmonized-card {
                will-change: transform;
            }
            
            .task-harmonized-card:hover {
                transform: translateY(-1px);
            }
            
            /* Responsive modal */
            @media (max-width: 768px) {
                .modal-content {
                    max-width: 100%;
                    margin: 20px;
                }
                
                .modal-header {
                    padding: 16px;
                }
                
                .modal-body {
                    padding: 16px;
                }
                
                .modal-footer {
                    padding: 16px;
                    flex-direction: column;
                    gap: 8px;
                }
                
                .modal-btn {
                    width: 100%;
                    justify-content: center;
                }
            }
        `;
    }

    // ================================================
    // HELPERS UTILITAIRES
    // ================================================
    
    throttle(func, wait) {
        let timeout;
        let lastCallTime = 0;
        
        return function executedFunction(...args) {
            const now = Date.now();
            const remaining = wait - (now - lastCallTime);
            
            const later = () => {
                lastCallTime = Date.now();
                timeout = null;
                func(...args);
            };
            
            if (remaining <= 0 || remaining > wait) {
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;
                }
                lastCallTime = now;
                func(...args);
            } else if (!timeout) {
                timeout = setTimeout(later, remaining);
            }
        };
    }

    dispatchEvent(eventName, detail) {
        try {
            window.dispatchEvent(new CustomEvent(eventName, { 
                detail: {
                    ...detail,
                    source: 'PageManager',
                    timestamp: Date.now(),
                    provider: this.currentProvider,
                    version: '15.0'
                }
            }));
        } catch (error) {
            console.error(`[PageManager] Erreur dispatch ${eventName}:`, error);
        }
    }

    // ================================================
    // CLEANUP ET DESTRUCTION
    // ================================================
    
    cleanup() {
        console.log('[PageManager] üßπ Nettoyage...');
        
        // Arr√™ter le monitoring
        this.stopProviderMonitoring();
        
        // Effacer les caches
        this.clearProviderCache();
        this._taskPreselectedCategoriesCache = null;
        this._newsletterPatterns = null;
        this._spamPatterns = null;
        this._newsletterDomains = null;
        this._suspiciousDomains = null;
        
        // Nettoyer les collections
        this.selectedEmails.clear();
        this.aiAnalysisResults.clear();
        this.createdTasks.clear();
        
        // Reset √©tat
        this.emailsCache = {
            rawEmails: [],
            processedEmails: [],
            lastUpdate: null,
            scanInProgress: false,
            errors: [],
            source: null
        };
    }

    destroy() {
        this.cleanup();
        this.currentPage = null;
        this.currentProvider = null;
        console.log('[PageManager] üí• Instance d√©truite');
    }
}

// ================================================
// INITIALISATION GLOBALE S√âCURIS√âE
// ================================================
(function() {
    // Nettoyer l'ancienne instance
    if (window.pageManager) {
        console.log('[PageManager] üîÑ Nettoyage ancienne instance...');
        try {
            window.pageManager.destroy?.();
        } catch (e) {
            console.warn('[PageManager] Erreur nettoyage:', e);
        }
    }

    console.log('[PageManager] üöÄ Cr√©ation nouvelle instance v15.0...');
    window.pageManager = new PageManager();

    // Bind des m√©thodes pour pr√©server le contexte
    const methods = Object.getOwnPropertyNames(PageManager.prototype);
    methods.forEach(name => {
        if (name !== 'constructor' && typeof window.pageManager[name] === 'function') {
            window.pageManager[name] = window.pageManager[name].bind(window.pageManager);
        }
    });

    // M√©thodes de debug globales
    window.debugPageManager = function() {
        return {
            version: '15.0',
            currentProvider: window.pageManager.currentProvider,
            connectionStatus: window.pageManager.connectionStatus,
            emailsInCache: window.pageManager.emailsCache.processedEmails.length,
            cacheSource: window.pageManager.emailsCache.source,
            cacheAge: window.pageManager.emailsCache.lastUpdate ? 
                Math.round((Date.now() - window.pageManager.emailsCache.lastUpdate) / 1000 / 60) + ' minutes' : 
                'Aucun cache',
            selectedEmails: window.pageManager.selectedEmails.size,
            currentPage: window.pageManager.currentPage,
            currentCategory: window.pageManager.currentCategory,
            searchTerm: window.pageManager.searchTerm,
            initialized: window.pageManager.initialized
        };
    };

    window.clearEmailCache = function() {
        localStorage.removeItem('emailsCachePersistent');
        sessionStorage.removeItem('lastScanResults');
        window.pageManager.emailsCache = {
            rawEmails: [],
            processedEmails: [],
            lastUpdate: null,
            scanInProgress: false,
            errors: [],
            source: null
        };
        console.log('[PageManager] Cache email effac√©');
        return 'Cache effac√©';
    };
})();

console.log('[PageManager] ‚úÖ PageManager v15.0 loaded - Version optimis√©e avec persistance!');
console.log('[PageManager] üíæ Cache persistant dans localStorage (24h)');
console.log('[PageManager] üöÄ Provider monitoring optimis√© (60s)');
console.log('[PageManager] üìß D√©tection Newsletter/Spam avec cache');
console.log('[PageManager] üîç Utilisez window.debugPageManager() pour debug');
console.log('[PageManager] üßπ Utilisez window.clearEmailCache() pour vider le cache');
